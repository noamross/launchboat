version: 2
jobs:
 build:
   machine: true
   steps:
     - checkout
     - run:
           name: Build Container
           command: |
            docker build -t $DOCKER_HUB_USER/launchboat .
     - run:
           name: Test Container
           command: |
            docker run --name lboat $DOCKER_HUB_USER/launchboat pkgtest.R https://github.com/ropensci/plater
            docker cp lboat:/home/rstudio/pkg /main/pkg
     - store_artifacts:
          path: /root/main/pkg/
          destination: artifacts
     - deploy:
           name: Push to Docker Hub
           command: |
              if [ "${CIRCLE_BRANCH}" == "master" ]; then
                docker login -u $DOCKER_HUB_USER -p $DOCKER_HUB_PASS
                docker push $DOCKER_HUB_USER/launchboat
              fi

workflows:
   version: 2
   main:
     jobs:
       - build
   nightly:
     triggers:
       - schedule:
           cron: "0 0 * * *"
           filters:
             branches:
               only:
                 - master
     jobs:
       - build


